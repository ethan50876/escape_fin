
#include "headers/music.h"

static int curr_note = 0;

const Note main_song[] = {
	{131, 20.0},
    {147, 20.0},
    {165, 20.0},
    {175, 20.0},
    {196, 20.0},
    {0, 10.0},
    {196, 10.0},
    {196, 10.0},
    {196, 10.0},
    {185, 10.0},
    {175, 10.0},
    {165, 10.0},
    {147, 10.0},
    {131, 10.0},
    {196, 20.0},
    {0, 10.0},
    {196, 10.0},
    {196, 10.0},
    {196, 10.0},
    {185, 10.0},
    {175, 10.0},
    {165, 10.0},
    {147, 10.0},
    {131, 10.0},
    {196, 20.0},
    {0, 10.0},
    {196, 10.0},
    {196, 10.0},
    {196, 10.0},
    {185, 10.0},
    {175, 10.0},
    {185, 10.0},
    {196, 10.0},
    {165, 10.0},
    {0, 20.0},
    {131, 20.0},
    {147, 20.0},
    {165, 20.0},
    {175, 20.0},
    {196, 20.0},
    {0, 10.0},
    {196, 10.0},
    {196, 10.0},
    {196, 10.0},
    {185, 10.0},
    {175, 10.0},
    {165, 10.0},
    {147, 10.0},
    {131, 10.0},
    {0, 10.0},
    {131, 10.0},
    {147, 10.0},
    {165, 10.0},
    {175, 10.0},
    {185, 10.0},
    {196, 10.0},
    {185, 10.0},
    {175, 10.0},
    {165, 10.0},
    {147, 10.0},
    {165, 10.0},
    {0, 40.0},
    {131, 20.0},
    {147, 20.0},
    {165, 20.0},
    {175, 20.0},
    {196, 20.0},
    {0, 10.0},
    {196, 10.0},
    {196, 10.0},
    {196, 10.0},
    {131, 10.0},
    {131, 10.0},
    {131, 10.0},
    {131, 10.0},
    {131, 10.0}
};

void start_music() {
  int sustain = 8;
  int vol = 11;

  set_envelope(triangle_inv_period, sustain);
  enable_channel(ch_c, true, false);
  set_volume(ch_c, vol);
}

void stop_music(Channel ch) {
	set_volume(ch, 0);
}

bool update_music(UINT32 time_elapsed) {
  bool next_note = false;

  if (time_elapsed >= main_song[curr_note].duration) {
    curr_note++;
    next_note = true;
  }

  if (curr_note > (NOTES_SZ - 1))
    curr_note = 0;

  set_tone(ch_c, main_song[curr_note].freq);

  return next_note;
}